<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">

<title>No 1 Yaari</title>
<head>
 
        <script src="scripts/aframe.min.js"></script>
        <script src="scripts/aframe-chromakey-material.min.js"></script>
    

<style>

.video-container {
height: 100%;
width: 100%;
overflow: hidden;
position: relative;
}

video {

object-fit: cover;
width: 100vw;
height: 100vh;
position: fixed;
top: 0;
left: 0;
}

</style>

</head>
 
<body>

  <div id="replayDiv" style='visibility:hidden; position: fixed; vertical-align: bottom; width: 30%;height: 30%; text-align: center; z-index: 1; top: 1%; right: 5%;'>
    <video id="replayVideo"  style="visibility:inherit ; width: 100%;height: 100%;position: relative;top: 0;left: 0;"></video>
    <button id="replayButton" style="visibility:inherit ; position: absolute; top: 45%;left: 45%;" onclick="replay()"  type="button">Play</button>
    <button id="downloadButton" style="visibility:hidden ; position: absolute; bottom: 1%;right: 1%;" onclick="download()"  type="button">Download</button>
  </div>

<div id="recordingButton" style='visibility:visible; position: fixed; vertical-align: bottom; width:200px; text-align: center; z-index: 1; bottom: 1%; left: 40%;'>
  <button id="buttonRecord" onclick="recordManager()"  type="button">Start Recording</button> 
</div>

<video id="ranavideo"  style="visibility:hidden"  src="video/rana.mp4" type="video/mp4" loop="true"></video>

<div id="MainGateDiv" class="video-container" style="visibility: visible;">
    <video id="videoElement" autoplay muted loop>
    </video>
</div>

<a-scene id="ascene" recorder vr-mode-ui="false">

   <a-entity id="camera" camera="userHeight: 1.6" look-controls cursor="rayOrigin: mouse"  raycaster="objects: .collidable" >
       <a-video  playsinline="" preload="" id="videoFeed"  src="#videoElement"  position="0 0 -2" scale="7 5 0.001" visible="true" rotation="0 0 0"></a-video>
   </a-entity>


<a-video  playsinline="" id="ranaVideo"  src="#ranavideo"  position="0 -0.1 -1.2" scale="0.9 1.62 0.001" visible="true" rotation="0 0 0"   material="shader: chromakey;  color: 0 0 1" ></a-video>


</a-scene>
	
<script>

function initAudioStream() {

var audioCtx = new window.AudioContext();
// create a stream from our AudioContext
var dest = audioCtx.createMediaStreamDestination();
aStream = dest.stream;
// connect our video element's output to the stream
var sourceNode = audioCtx.createMediaElementSource(ranavideo);
sourceNode.connect(dest)
  // start the video
document.getElementById("ranavideo").play();
sourceNode.connect(audioCtx.destination)
};

var video = document.querySelector("#videoElement");
document.getElementById("ranavideo").load();

video.setAttribute('autoplay', '');
video.setAttribute('muted', '');
video.setAttribute('playsinline', '');

if (navigator.mediaDevices.getUserMedia) {

  let constraintObjBasic = { 
            audio: true, 
            video: { facingMode: "environment" }
  };  

 navigator.mediaDevices.getUserMedia(constraintObjBasic)
    .then(function (stream) {
      video.srcObject = stream;
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}

var recording = false;
var canDownload = false;
var downloadableBlob = null;
AFRAME.registerComponent('recorder', {

    schema: { type: 'string', default: 'recordingCanvas.webm' },

    init: function () {
    this.el.addEventListener('start', this.start.bind(this))
    this.el.addEventListener('stop', this.stop.bind(this))
    },

    start: function () {
        initAudioStream();
        var stream = this.el.querySelector('canvas').captureStream(25)
        stream.addTrack(aStream.getAudioTracks()[0]);
        var options;
        try {
          options = {mimeType: 'video/webm'};
          // if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
          // options = {mimeType: 'video/webm; codecs=vp9'};
          // } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
          //   options = {mimeType: 'video/webm; codecs=vp8'};
          // } else {
          //   options = {mimeType: 'video/webm'};
          // }
        this._recorder = new MediaRecorder(stream, options)
        } catch (e) {
          console.error('Exception while creating MediaRecorder:', e);
          return;
        }
        
        var frames = []

        this._recorder.ondataavailable = function (evt) {
            if (evt.data) {
                frames.push(evt.data);
            }
        }

        this._recorder.onstop = () => {
            console.log(frames.length);
            var fileBlob = new Blob(frames, { type: 'video/webm' })
            if(canDownload){
              downloadableBlob = fileBlob;
              document.getElementById("replayVideo").src = window.URL.createObjectURL(fileBlob)
              canDownload = false;
            }

            frames = []
        }

        this._recorder.start(1)
        
    },

    stop: function () {
    if(!this._recorder) return
    this._recorder.stop()
    document.getElementById("replayDiv").style.visibility = "visible";
    }
})

function recordManager() {
  //var vid = document.getElementById("ranavideo");
  var vid = document.querySelector("#ranavideo");
    if(recording){
        canDownload = true;
        //document.getElementById("ranavideo").pause();
        vid.pause();
        document.getElementById("ascene").components.recorder.stop();
        document.getElementById("buttonRecord").innerHTML = "Start Recording";
        console.log('Recording stopped');
        recording = false;
    }else{
        document.getElementById("ascene").components.recorder.start();
        //document.getElementById("ranavideo").play();
        vid.play();
        document.getElementById("buttonRecord").innerHTML = "Stop Recording";
        console.log('Recording started');
        recording = true;
    }
}

function replay(){
  document.getElementById("replayVideo").play();
  document.getElementById("replayButton").style.visibility = "hidden";
  document.getElementById("downloadButton").style.visibility = "visible";
}

function download(){
  var dataUrl = window.URL.createObjectURL(downloadableBlob)
  var link = document.createElement('a')
  link.href = dataUrl
  link.download = this.data;
  link.click();
}
</script>
</body>
</html>
